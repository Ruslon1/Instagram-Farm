name: Auto Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
          cd /root/instagram-bot || exit 1
          
          # ĞŸÑƒĞ»Ğ»Ğ¸Ğ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main
          
          # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
          echo "ğŸ›‘ Stopping containers..."
          docker-compose down
          
          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
          echo "ğŸ”¨ Building and starting containers..."
          docker-compose up -d --build
          
          # Ğ–Ğ´ĞµĞ¼ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
          sleep 10
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
          echo "ğŸ” Checking service health..."
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "âœ… Backend is healthy"
          else
            echo "âŒ Backend health check failed"
            docker-compose logs app
          fi
          
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… Frontend is healthy"
          else
            echo "âŒ Frontend health check failed"
            docker-compose logs frontend
          fi
          
          echo "ğŸ‰ Deployment completed at $(date)"