name: Auto Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        timeout: 20m
        command_timeout: 30m
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
          cd /home/ruslan/instagram-bot || exit 1
          
          # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
          echo "ğŸ‘¤ User: $(whoami)"
          echo "ğŸ“ Directory: $(pwd)"
          echo "ğŸ“ Current commit: $(git rev-parse HEAD)"
          
          # ĞŸÑƒĞ»Ğ»Ğ¸Ğ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main
          
          # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚
          echo "ğŸ“ New commit: $(git rev-parse HEAD)"
          
          # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
          echo "ğŸ›‘ Stopping containers..."
          docker-compose down
          
          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹ Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
          echo "ğŸ”¨ Building and starting containers..."
          
          # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ buildx Ğ´Ğ»Ñ Ğ»ÑƒÑ‡ÑˆĞµĞ³Ğ¾ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
          export DOCKER_BUILDKIT=1
          export COMPOSE_DOCKER_CLI_BUILD=1
          
          docker-compose build --parallel
          docker-compose up -d
          
          # Ğ–Ğ´ĞµĞ¼ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
          echo "â³ Waiting for services to start..."
          sleep 15
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²
          echo "ğŸ“Š Container status:"
          docker-compose ps
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
          echo "ğŸ” Checking service health..."
          
          # Backend health check Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ°Ğ¼Ğ¸
          BACKEND_HEALTHY=false
          for i in {1..6}; do
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… Backend is healthy"
              BACKEND_HEALTHY=true
              break
            else
              echo "â³ Backend not ready yet (attempt $i/6)..."
              sleep 5
            fi
          done
          
          if [ "$BACKEND_HEALTHY" = false ]; then
            echo "âŒ Backend health check failed"
            echo "ğŸ“‹ Backend logs:"
            docker-compose logs --tail=10 app
          fi
          
          # Frontend health check Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ°Ğ¼Ğ¸
          FRONTEND_HEALTHY=false
          for i in {1..4}; do
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "âœ… Frontend is healthy"
              FRONTEND_HEALTHY=true
              break
            else
              echo "â³ Frontend not ready yet (attempt $i/4)..."
              sleep 5
            fi
          done
          
          if [ "$FRONTEND_HEALTHY" = false ]; then
            echo "âŒ Frontend health check failed"
            echo "ğŸ“‹ Frontend logs:"
            docker-compose logs --tail=10 frontend
          fi
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Celery
          if docker-compose ps celery | grep -q "Up"; then
            echo "âœ… Celery worker is running"
          else
            echo "âŒ Celery worker is not running"
            echo "ğŸ“‹ Celery logs:"
            docker-compose logs --tail=10 celery
          fi
          
          echo ""
          echo "ğŸ‰ Deployment completed at $(date)"
          echo "ğŸŒ Frontend: http://94.131.86.226:3000"
          echo "ğŸ”§ Backend: http://94.131.86.226:8000"